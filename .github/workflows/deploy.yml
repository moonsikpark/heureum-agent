name: Deploy to AKS

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'heureum-client/**'
      - 'heureum-mobile/**'
      - '*.md'

permissions:
  id-token: write
  contents: read

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
  CLUSTER_NAME: ${{ secrets.CLUSTER_NAME }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ github.sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push agent image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/heureum-agent:${{ github.sha }} \
            -f heureum-agent/Dockerfile heureum-agent/
          docker push ${{ env.ACR_NAME }}.azurecr.io/heureum-agent:${{ github.sha }}

      - name: Build and push platform image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/heureum-platform:${{ github.sha }} \
            -f heureum-platform/Dockerfile heureum-platform/
          docker push ${{ env.ACR_NAME }}.azurecr.io/heureum-platform:${{ github.sha }}

      - name: Build and push frontend image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/heureum-frontend:${{ github.sha }} \
            --build-arg VITE_API_URL=/ \
            -f heureum-frontend/Dockerfile heureum-frontend/
          docker push ${{ env.ACR_NAME }}.azurecr.io/heureum-frontend:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: az aks get-credentials --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }}

      - name: Create namespace
        run: kubectl apply -f heureum-infra/k8s/namespace.yaml

      - name: Create/update secrets
        run: |
          kubectl create secret generic heureum-secrets \
            --namespace=heureum \
            --from-literal=OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            --from-literal=SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }} \
            --from-literal=DATABASE_URL=${{ secrets.DATABASE_URL }} \
            --from-literal=AZURE_COMMUNICATION_CONNECTION_STRING=${{ secrets.AZURE_COMMUNICATION_CONNECTION_STRING }} \
            --from-literal=DEFAULT_FROM_EMAIL=${{ secrets.DEFAULT_FROM_EMAIL }} \
            --from-literal=FRONTEND_URL=${{ secrets.FRONTEND_URL }} \
            --from-literal=GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} \
            --from-literal=GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }} \
            --from-literal=MICROSOFT_CLIENT_ID=${{ secrets.MICROSOFT_CLIENT_ID }} \
            --from-literal=MICROSOFT_CLIENT_SECRET=${{ secrets.MICROSOFT_CLIENT_SECRET }} \
            --from-literal=AZURE_STORAGE_ACCOUNT_NAME=${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
            --from-literal=AZURE_STORAGE_ACCOUNT_KEY=${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }} \
            --from-literal=AZURE_STORAGE_CONTAINER_NAME=${{ secrets.AZURE_STORAGE_CONTAINER_NAME }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create/update ACR pull secret
        run: |
          kubectl create secret docker-registry acr-secret \
            --namespace=heureum \
            --docker-server=${{ env.ACR_NAME }}.azurecr.io \
            --docker-username=${{ env.ACR_NAME }} \
            --docker-password=${{ secrets.ACR_PASSWORD }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Install cert-manager
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.17.2/cert-manager.yaml
          kubectl wait --for=condition=Available deployment/cert-manager -n cert-manager --timeout=120s
          kubectl wait --for=condition=Available deployment/cert-manager-webhook -n cert-manager --timeout=120s

      - name: Apply ClusterIssuer
        run: kubectl apply -f heureum-infra/k8s/cluster-issuer.yaml

      - name: Template domain into manifests
        run: |
          sed -i "s/DOMAIN_PLACEHOLDER/${{ secrets.DOMAIN }}/g" \
            heureum-infra/k8s/ingress.yaml \
            heureum-infra/k8s/platform.yaml

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f heureum-infra/k8s/agent.yaml
          kubectl apply -f heureum-infra/k8s/platform.yaml
          kubectl apply -f heureum-infra/k8s/frontend.yaml
          kubectl apply -f heureum-infra/k8s/ingress.yaml

      - name: Update image tags
        env:
          TAG: ${{ github.sha }}
          ACR: ${{ env.ACR_NAME }}.azurecr.io
        run: |
          kubectl set image deployment/heureum-agent agent=$ACR/heureum-agent:$TAG -n heureum
          kubectl set image deployment/heureum-platform platform=$ACR/heureum-platform:$TAG -n heureum
          kubectl set image deployment/heureum-platform migrate=$ACR/heureum-platform:$TAG -n heureum
          kubectl set image deployment/heureum-frontend frontend=$ACR/heureum-frontend:$TAG -n heureum

      - name: Wait for rollouts
        run: |
          kubectl rollout status deployment/heureum-agent -n heureum --timeout=120s
          kubectl rollout status deployment/heureum-platform -n heureum --timeout=120s
          kubectl rollout status deployment/heureum-frontend -n heureum --timeout=120s
